# This will be my first attempt at writing and executing commands and scripts in VScode for analyzing sequence data on the TSCC

cd ~
    # Mirror home dir on cluster with desktop folder
sshfs mioverto@tscc-login.sdsc.edu:/home/mioverto ~/Desktop/TSCC_home
sshfs mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto ~/Desktop/TSCC_scratch

#############################################
    # Access the cluster over ssh
ssh mioverto@tscc-login.sdsc.edu
628seliM318

    # Start an interactive session
qsub -I -A svenkata

    # To access home dir:
cd /home/mioverto

    # To access scratch dir:
cd /oasis/tscc/scratch/mioverto/


###########
    # Can edit the BASH profile by :
vim ~/.bash_profile

    # After opening the bash_profile (in vim) type i and you'll see message -INSERT- at the bottom of your screen. 
    # Then - type your line (source ~/.profile) and save it by hitting the esc button and then typing :w 
    # Exit with :q <enter>

#########
    # rclone was installed in home/mioverto/bin and authorized to be used anywhere
    # therefore, can just navigate to desired dir and use rclone copy

# cd /oasis/tscc/scratch/mioverto/
# rclone copy SKLAB_DATA:/2019_11_08_Dutton_Barcode_and_MutAccum_SG/MA_seq_data MAseq1
    # this created a dir in scratch/mioverto/ called MAseq1 with all fastq.gz files

    # You can then decompress all files in the dir with:
    # gunzip *gz

######
# Now that files are in the right place, now what?

# show structure of directories. Seems to only go to a depth of 2 dirs (two different styles)
ls -R | grep ":$" | sed -e 's/:$//' -e 's/[^-][^\/]*\//--/g' -e 's/^/   /' -e 's/-/|/'
ls -R | grep ":$" | sed -e 's/:$//' -e 's/[^-][^\/]*\// /g' -e 's/^/ /'
# Structure of home dir
   .
   |-bin
   |---rclone_dir
   |-----oasis
   |-------tscc
   |---------scratch
   |-----------mioverto
   |-------------MA_seq

# Structure of scratch dir
.
   |-bin
   |-code
   |---Trimmomatic-0.36
   |-----adapters
   |-data
   |---MAseq1
   |-----bam
   |-------bam_raw
   |-------DeDup
   |---------temp_dir
   |-------picard_metrics
   |---------archive
   |-------temp_dir
   |-------unsorted
   |-----depth
   |-------archive
   |---------01_29_20
   |-----reads
   |-----trim
   |-log
   |---align
   |---archive
   |-----MAseq1_trim
   |---DeDup
   |---depth
   |-plan

#############################################
# .fastq files to scratch dir

rclone copy SKLAB_DATA:/2019_11_08_Dutton_Barcode_and_MutAccum_SG/MA_seq_data MAseq1

rclone copy -P  --exclude Dutton_Data/** --exclude Reports/** --exclude Stats/** SKLAB_DATA:/2019_11_08_Kryazhimskiy_Barcode_and_MutAccum_SG MAseq2

rclone copy -P SKLAB_DATA:/2020_01_08_Kryazhimskiy_Robust_MutAcc_MO_AM/2020_01_08_MAseq_MO reads

2020_01_08_Kryazhimskiy_Robust_MutAcc_MO_AM

#############################################
# Script files to TSCC

#### Renaming
scp /Users/Mastermind/MA_seq/scripts/Rename/rename_fastq_bash_012720.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/bin
# copy renaming script to cluster
scp /Users/Mastermind/MA_seq/scripts/Rename/rename_fastq_030620.py mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/code
# copy planfile to cluster
scp /Users/Mastermind/MA_seq/scripts/Rename/planfiles/2019_11_08_SK_SG_plan.txt mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/plan

# copy reference sequence to cluster
scp /Users/Mastermind/MA_seq/refseq/S288C_R63_RM.fasta mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/data/refseq

#*********** For making RM reference sequence

scp ~/SK_Lab/PhD_Projects/mutAccum/refseq/RM11-1a_UCI_2019.fna mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/data/refseq


#### Adapter trimming
# scp -r /Users/Mastermind/MA_seq/scripts/Trimmomatic-0.36 mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/code
scp -r /Users/Mastermind/MA_seq/scripts/qsub_trimmomatic_012720.sh mioverto@tscc-login.sdsc.edu:/home/mioverto/bin
scp -r /Users/Mastermind/MA_seq/scripts/trimmomatic_fastq_012720.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/code

#### Alignment
scp -r /Users/Mastermind/MA_seq/scripts/Align/submit_bowtie_012920.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/bin
scp -r /Users/Mastermind/MA_seq/scripts/bowtie_samtools_012920.sbatch mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/code

#### Mark Duplicates
scp -r /Users/Mastermind/MA_seq/scripts/submit_picard_012920_2.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/bin
scp -r /Users/Mastermind/MA_seq/scripts/picard_sam_012920_2.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/code

#### Read Depth
scp -r /Users/Mastermind/MA_seq/scripts/submit_depth_table_012920.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/bin
scp -r /Users/Mastermind/MA_seq/scripts/bam_depth_table.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/code

#### Sliding window read depth
scp -r /Users/Mastermind/MA_seq/scripts/qsub_cov_slide_020720.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/bin
scp -r /Users/Mastermind/MA_seq/scripts/run_cov_slide.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/bin
scp -r /Users/Mastermind/MA_seq/scripts/coverage_slide.v0.1.py mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/code

#### Variant Calling
scp -r /Users/Mastermind/MA_seq/scripts/Variant/submit_bcftools_call_VCF.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/bin
scp -r /Users/Mastermind/MA_seq/scripts/Variant/bcftools_call_VCF_021020.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/code
scp -r /Users/Mastermind/MA_seq/scripts/Variant/half-anc-1_pos.txt mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/code
scp -r /Users/Mastermind/MA_seq/scripts/Variant/POS_files/Bloom_pos_GT.vcf mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/code


#### VCF Filtering

#### Merge VCFs
scp -r /Users/Mastermind/MA_seq/scripts/combine/combine_vcfs_021320.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/bin
scp -r /Users/Mastermind/MA_seq/scripts/combine/malformed_vcf.v1.1.py mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/code

####
# upload scripts for filtering VCFs
scp -r /Users/Mastermind/MA_seq/scripts/submit_filter_VCFs.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/bin
scp -r /Users/Mastermind/MA_seq/scripts/filter_VCFs.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/code
###

####
# scripts that take a set of trimmed paird and unpaired read sequence files and outputs a set of VCF files
scp -r /Users/Mastermind/MA_seq/scripts/Submit_MO-pipe.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/bin
scp -r /Users/Mastermind/MA_seq/scripts/Align-VCF_MO-pipe.sh mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/code
scp -r /Users/Mastermind/MA_seq/scripts/Variant/POS_files/Bloom_pos_crctd.txt mioverto@tscc-login.sdsc.edu:/oasis/tscc/scratch/mioverto/data/MAseq1/variant_calls/POS_files
###

# Permissions for all scripts in the / code dir
chmod 777 /oasis/tscc/scratch/mioverto/code/*
chmod 777 /oasis/tscc/scratch/mioverto/bin/*
chmod 777 /home/mioverto/bin/*
chmod 777 /oasis/tscc/scratch/mioverto/data/MAseq1/variant_calls

# Running conda
/home/mioverto/bin/miniconda2/bin/conda
/home/mioverto/bin/miniconda2/bin/python2

# to run a script in the scratch/bin dir
cd /oasis/tscc/scratch/mioverto/bin
./Submit_MO-pipe.sh

    # Access the cluster over ssh
ssh mioverto@tscc-login.sdsc.edu
628seliM318

# Developling bcftools variant calling scripts
export VCFIN=/oasis/tscc/scratch/mioverto/data/MAseq1/variant_calls/0x0-GM58_1.vcf
export VCFOUT=/oasis/tscc/scratch/mioverto/data/MAseq1/variant_calls/filtered/0x0-GM58_1.fltr.vcf
export SAMPLE=$(echo $(basename ${VCFIN} .vcf))

# delete files > 5 days old
# find /oasis/tscc/scratch/mioverto/data/MAseq1/variant_calls -mtime +5 -exec rm {} +

# create alternate reference sequence

module load bcftools
module load tabix

export VCFIN=/oasis/tscc/scratch/mioverto/code/Bloom_pos_GT.vcf
export VCFGZ=/oasis/tscc/scratch/mioverto/code/Bloom_pos_GT.vcf.gz
export REFSEQ=/oasis/tscc/scratch/mioverto/data/S288C_R63_refseq.fna


bgzip -c $VCFIN > $VCFGZ
tabix $VCFGZ
bcftools index $VCFGZ | bcftools consensus -f $REFSEQ > S288C_R63_RM.fa

# rclone back to Mastermind
rclone copy TSCC:/oasis/tscc/scratch/mioverto/data/MAseq2/anc/variant_calls/ ~/MA_seq/data/MAseq2/anc


    # Access the cluster over ssh
ssh mioverto@tscc-login.sdsc.edu
628seliM318


    # Start an interactive session
qsub -I -A svenkata

# which jobs are running
qstat -q hotel
qstat -r

qstat -u mioverto
qstat -r -u mioverto

yqd --user=mioverto --queue=queue
yqd 20407721
checkjob
checkjob 20476463
qselect -u mioverto -s R | xargs qdel
qdel <jobID>

qdel 21190354

# See available time on account
gbalance -u mioverto

#See available modules
module avail

    # Remove item
rm <file or dir> -d

# get filename from path
path=/oasis/tscc/scratch/mioverto/data/MAseq1/0x0-GM58_1_R1.fastq
file=$(basename "$path")
file=${/oasis/tscc/scratch/mioverto/data/MAseq1/0x0-GM58_1_R1.fastq##*/}
file=$(basename "$path")
# show structure of directories. Seems to only go to a depth of 2 dirs (two different styles)
ls -R | grep ":$" | sed -e 's/:$//' -e 's/[^-][^\/]*\//--/g' -e 's/^/   /' -e 's/-/|/'
ls -R | grep ":$" | sed -e 's/:$//' -e 's/[^-][^\/]*\// /g' -e 's/^/ /'


[E::hts_open_format] Failed to open file /oasis/tscc/scratch/mioverto/data/MAseq1/bam/trim.0000.bam

R1FILE=half-L96_1_R1U.trimmed.fastq

list of file names
a way to loop over it
a way to loop through replacements


OLDNAME=GM71
NEWNAME=N_C00

a=1
for R1FILE in ${OLDNAME}*; do \

    mv -n ${R1FILE} ./${NEWNAME}_R${a}.fastq.gz
    let a=a+1
done

 GM44    H_C00   
 GM45    H_D00
 GM46    H_E00
 GM47    H_F00
 GM48    H_G00
 GM49    H_H00
 GM53    F_C00
 GM54    F_D00
 GM55    F_E00
 GM56    F_F00
 GM57    F_G00
 GM59    N_D00
 GM61    N_G00
 GM71    N_C00
 GM72    N_E00


rename -n 's/L96/L096/' *

2019_11_08_SK_SG_planfile.txt

eval "$(sed 's/^/mv /g' /oasis/tscc/scratch/mioverto/plan/2019_11_08_SK_SG_planfile.txt )"

#!/bin/bash
INPUT="$1"
IFS=,
[ ! -f "$INPUT" ] && { echo "$INPUT file not found"; exit 99; }
while read old_name new_name
do
rename "$old_name" "$new_name" # mv or rename
done < "$INPUT"


export FQDIR=/oasis/tscc/scratch/mioverto/data/MAseq3/reads/anc

for r1file in $FQDIR/*; do
    # echo $r1file
    gunzip $r1file
done


#########################################################

#########################################################
# Retrieve files from cluster to Mastermind

rclone copy TSCC:/oasis/tscc/scratch/mioverto/data/MAseq1/variant_calls/neg/filter MAseq_data:/MA_seq/data



###########################################










# activate env
conda activate MAseq
# Mastermind $PATH in MA_seq env
/Library/Frameworks/Python.framework/Versions/3.8/bin:
/Users/Mastermind/opt/miniconda3/envs/MAseq/bin:
/Users/Mastermind/opt/miniconda3/condabin:
/miniconda3/bin:
/Library/Frameworks/Python.framework/Versions/3.7/bin:
/usr/local/bin:
/usr/bin:
/bin:
/usr/sbin:
/sbin:
/Users/Mastermind/MA_seq/bin



~/Applications/MUMmer3.23/nucmer --prefix=RM_ref ~/SK_Lab/PhD_Projects/mutAccum/refseq/S288C_R64_refseq.fasta ~/SK_Lab/PhD_Projects/mutAccum/refseq/RM11-1a_UCI_2019.fasta
~/Applications/MUMmer3.23/nucmer --prefix=RM_ref S288C_R64_refseq.fasta RM11-1a_UCI_2019.fasta

~/Applications/MUMmer3.23/show-coords RM_ref.delta
~/Applications/MUMmer3.23/show-tiling RM_ref.delta
~/Applications/MUMmer3.23/show-snps RM_ref.delta > RM_ref.snps
